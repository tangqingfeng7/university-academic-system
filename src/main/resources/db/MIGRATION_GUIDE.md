# æ•°æ®åº“è¿ç§»æŒ‡å—

æœ¬æ–‡æ¡£æä¾›æ•°æ®åº“æ¶æ„è¿ç§»çš„å®Œæ•´æŒ‡å—ï¼ŒåŒ…æ‹¬è¿ç§»å†å²ã€æ‰§è¡Œé¡ºåºå’Œç‰ˆæœ¬è¯´æ˜ã€‚

## å¿«é€Ÿå¯¼èˆª

- [è¿ç§»æ–‡ä»¶è¯¦ç»†è¯´æ˜](migration/README.md)
- [æµ‹è¯•æ•°æ®ä½¿ç”¨æŒ‡å—](test-data/README.md)

## è¿ç§»ç‰ˆæœ¬æ€»è§ˆ

### å½“å‰ç‰ˆæœ¬ï¼šV28
### æœ€åæ›´æ–°ï¼š2025-10-13

| ç‰ˆæœ¬ | æ–‡ä»¶å | æè¿° | çŠ¶æ€ |
|-----|-------|------|------|
| V5 | add_exam_room_version.sql | æ·»åŠ è€ƒåœºç‰ˆæœ¬å·å­—æ®µ | âœ… å·²å‘å¸ƒ |
| V6 | add_course_selection_enabled.sql | æ·»åŠ é€‰è¯¾å¯ç”¨æ ‡å¿— | âœ… å·²å‘å¸ƒ |
| V7 | create_course_change_request.sql | åˆ›å»ºè°ƒè¯¾ç”³è¯·è¡¨ | âœ… å·²å‘å¸ƒ |
| V8 | create_student_status_change_tables.sql | åˆ›å»ºå­¦ç±å¼‚åŠ¨ç›¸å…³è¡¨ | âœ… å·²å‘å¸ƒ |
| V9 | add_student_status_column.sql | æ·»åŠ å­¦ç”ŸçŠ¶æ€åˆ— | âœ… å·²å‘å¸ƒ |
| V10 | create_exam_tables.sql | åˆ›å»ºè€ƒè¯•ç®¡ç†è¡¨ | âœ… å·²å‘å¸ƒ |
| V11 | create_approval_enhancement_tables.sql | åˆ›å»ºå®¡æ‰¹æµç¨‹å¢å¼ºè¡¨ | âœ… å·²å‘å¸ƒ |
| V12 | create_evaluation_tables.sql | åˆ›å»ºæ•™å­¦è¯„ä»·è¡¨ | âœ… å·²å‘å¸ƒ |
| V13 | create_classroom_tables.sql | åˆ›å»ºæ•™å®¤ç®¡ç†è¡¨ | âœ… å·²å‘å¸ƒ |
| V14 | fix_approval_tables_foreign_keys.sql | ä¿®å¤å®¡æ‰¹è¡¨å¤–é”®çº¦æŸ | âœ… å·²å‘å¸ƒ |
| V15 | create_leave_request_table.sql | åˆ›å»ºå­¦ç”Ÿè¯·å‡ç”³è¯·è¡¨ | âœ… å·²å‘å¸ƒ |
| V16 | create_scheduling_tables.sql | åˆ›å»ºæ™ºèƒ½æ’è¯¾æ¨¡å—è¡¨ | âœ… å·²å‘å¸ƒ |
| V17 | placeholder_reserved.sql | é¢„ç•™ç‰ˆæœ¬å· | âš ï¸ å ä½ç¬¦ |
| V18 | placeholder_reserved.sql | é¢„ç•™ç‰ˆæœ¬å·ï¼ˆåŸæµ‹è¯•æ•°æ®ï¼‰ | âš ï¸ å ä½ç¬¦ |
| V19 | add_missing_comments_and_timestamps.sql | ç»Ÿä¸€æ·»åŠ è¡¨æ³¨é‡Šå’Œæ—¶é—´æˆ³ | âœ… å·²å‘å¸ƒ |
| V20 | add_grade_point_column.sql | æ·»åŠ ç»©ç‚¹å­—æ®µåŠè‡ªåŠ¨è®¡ç®—è§¦å‘å™¨ | âœ… å·²å‘å¸ƒ |
| V21 | placeholder_reserved.sql | é¢„ç•™ç‰ˆæœ¬å· | âš ï¸ å ä½ç¬¦ |
| V22 | create_class_table.sql | åˆ›å»ºç­çº§ç®¡ç†è¡¨ | âœ… å·²å‘å¸ƒ |
| V23 | unify_class_names.sql | ç»Ÿä¸€ç­çº§åç§°è§„èŒƒ | âœ… å·²å‘å¸ƒ |
| V24 | populate_standard_classes.sql | å¡«å……æ ‡å‡†ç­çº§æ•°æ® | âœ… å·²å‘å¸ƒ |
| V25 | create_discipline_tables.sql | åˆ›å»ºå­¦ç”Ÿå¤„åˆ†ç®¡ç†è¡¨ | âœ… å·²å‘å¸ƒ |
| V26 | add_discipline_approval_status.sql | æ·»åŠ å¤„åˆ†å®¡æ‰¹çŠ¶æ€å­—æ®µ | âœ… å·²å‘å¸ƒ |
| V27 | add_missing_table_comments.sql | è¡¥å……ç¼ºå¤±çš„è¡¨æ³¨é‡Š | âœ… å·²å‘å¸ƒ |
| V28 | create_schedule_item_table.sql | åˆ›å»ºæ’è¯¾ç»“æœè¯¦æƒ…è¡¨ | âœ… å·²å‘å¸ƒ |

## æ•°æ®åº“æ¶æ„æ¼”è¿›å†å²

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„ (V1-V4)
**æ—¶é—´**ï¼š2024å¹´åˆ  
**åŒ…å«å†…å®¹**ï¼š
- ç”¨æˆ·ã€é™¢ç³»ã€ä¸“ä¸šã€å­¦ç”Ÿã€æ•™å¸ˆåŸºç¡€è¡¨
- è¯¾ç¨‹ã€å­¦æœŸã€é€‰è¯¾ã€æˆç»©ç®¡ç†
- ç³»ç»Ÿé…ç½®ã€æ“ä½œæ—¥å¿—

**è¯´æ˜**ï¼šè¿™äº›è¡¨åœ¨åˆå§‹ `schema.sql` ä¸­åˆ›å»ºï¼Œæœªå•ç‹¬ç‰ˆæœ¬åŒ–

---

### ç¬¬äºŒé˜¶æ®µï¼šè€ƒè¯•ä¸å®¡æ‰¹æ¨¡å— (V5-V11)
**æ—¶é—´**ï¼š2024å¹´10æœˆ  
**æ–°å¢åŠŸèƒ½**ï¼š
- **V5-V6**: è€ƒè¯•ç®¡ç†å¢å¼º
- **V7**: è°ƒè¯¾ç”³è¯·æµç¨‹
- **V8-V9**: å­¦ç±å¼‚åŠ¨ç®¡ç†
- **V10**: å®Œæ•´è€ƒè¯•ç³»ç»Ÿï¼ˆè€ƒåœºã€ç›‘è€ƒã€åº§ä½ï¼‰
- **V11**: é€šç”¨å®¡æ‰¹æµç¨‹æ¡†æ¶

---

### ç¬¬ä¸‰é˜¶æ®µï¼šè¯„ä»·ä¸èµ„æºç®¡ç† (V12-V16)
**æ—¶é—´**ï¼š2024å¹´10æœˆ  
**æ–°å¢åŠŸèƒ½**ï¼š
- **V12**: æ•™å­¦è¯„ä»·ç³»ç»Ÿï¼ˆè¯¾ç¨‹è¯„ä»·ã€æ•™å¸ˆè¯„ä»·ï¼‰
- **V13**: æ•™å®¤èµ„æºç®¡ç†ï¼ˆæ•™å®¤å€Ÿç”¨ã€æ•™å®¤ç»Ÿè®¡ï¼‰
- **V14**: å®¡æ‰¹æµç¨‹ä¿®å¤ï¼ˆå¤–é”®å®Œæ•´æ€§ï¼‰
- **V15**: å­¦ç”Ÿè¯·å‡ç”³è¯·
- **V16**: æ™ºèƒ½æ’è¯¾ç³»ç»Ÿï¼ˆæ’è¯¾çº¦æŸã€æ•™å¸ˆåå¥½ã€æ’è¯¾æ–¹æ¡ˆï¼‰

---

### ç¬¬å››é˜¶æ®µï¼šæ•°æ®å®Œå–„ä¸æ ‡å‡†åŒ– (V17-V21)
**æ—¶é—´**ï¼š2025å¹´10æœˆ  
**æ”¹è¿›å†…å®¹**ï¼š
- **V17-V18**: ç‰ˆæœ¬å·é¢„ç•™ï¼ˆä¿æŒè¿ç»­æ€§ï¼‰
- **V19**: ç»Ÿä¸€æ‰€æœ‰è¡¨çš„ `updated_at` å­—æ®µå’Œè¡¨æ³¨é‡Š
- **V20**: æˆç»©ç»©ç‚¹è®¡ç®—è‡ªåŠ¨åŒ–ï¼ˆè§¦å‘å™¨ï¼‰
- **V21**: ç‰ˆæœ¬å·é¢„ç•™

---

### ç¬¬äº”é˜¶æ®µï¼šç­çº§ä¸å¤„åˆ†ç®¡ç† (V22-V28)
**æ—¶é—´**ï¼š2025å¹´10æœˆ  
**æ–°å¢åŠŸèƒ½**ï¼š
- **V22-V24**: ç­çº§ç®¡ç†ç³»ç»Ÿï¼ˆç­çº§è¡¨ã€æ•°æ®æ ‡å‡†åŒ–ã€æ‰¹é‡å¡«å……ï¼‰
- **V25-V26**: å­¦ç”Ÿå¤„åˆ†ç®¡ç†ï¼ˆå¤„åˆ†è®°å½•ã€ç”³è¯‰ã€å®¡æ‰¹æµç¨‹ï¼‰
- **V27**: è¡¨æ³¨é‡Šè¡¥å……ï¼ˆé€€æ¬¾å®¡æ‰¹ã€æ’è¯¾ç»“æœï¼‰
- **V28**: æ’è¯¾ç»“æœè¯¦æƒ…è¡¨ï¼ˆä¸ V16 é…å¥—ï¼‰

---

## æ¨¡å—åŠŸèƒ½çŸ©é˜µ

| æ¨¡å— | ä¸»è¦è¡¨ | ç›¸å…³è¿ç§»ç‰ˆæœ¬ | çŠ¶æ€ |
|-----|-------|------------|------|
| ç”¨æˆ·ç®¡ç† | sys_user | V1-V4 (schema.sql) | âœ… ç¨³å®š |
| ç»„ç»‡æ¶æ„ | department, major | V1-V4 (schema.sql) | âœ… ç¨³å®š |
| å­¦ç”Ÿç®¡ç† | student, student_status_change | V1-V4, V8-V9 | âœ… ç¨³å®š |
| æ•™å¸ˆç®¡ç† | teacher | V1-V4 (schema.sql) | âœ… ç¨³å®š |
| è¯¾ç¨‹ç®¡ç† | course, course_offering, course_prerequisite | V1-V4 (schema.sql) | âœ… ç¨³å®š |
| é€‰è¯¾ç®¡ç† | course_selection | V1-V4, V6 | âœ… ç¨³å®š |
| æˆç»©ç®¡ç† | grade | V1-V4, V20 | âœ… ç¨³å®š |
| è€ƒè¯•ç®¡ç† | exam, exam_room, exam_invigilator | V5, V10 | âœ… ç¨³å®š |
| è°ƒè¯¾ç”³è¯· | course_change_request | V7 | âœ… ç¨³å®š |
| å®¡æ‰¹æµç¨‹ | approval_configuration, approval_level_approver | V11, V14 | âœ… ç¨³å®š |
| æ•™å­¦è¯„ä»· | course_evaluation, teacher_evaluation, evaluation_period | V12 | âœ… ç¨³å®š |
| æ•™å®¤ç®¡ç† | classroom, classroom_booking | V13 | âœ… ç¨³å®š |
| è¯·å‡ç®¡ç† | leave_request | V15 | âœ… ç¨³å®š |
| æ™ºèƒ½æ’è¯¾ | scheduling_constraint, scheduling_solution, teacher_preference, schedule_item | V16, V28 | âœ… ç¨³å®š |
| ç­çº§ç®¡ç† | class | V22-V24 | âœ… ç¨³å®š |
| å¤„åˆ†ç®¡ç† | student_discipline, discipline_appeal | V25-V26 | âœ… ç¨³å®š |
| æ¯•ä¸šå®¡æ ¸ | graduation_audit, graduation_requirement | archive/ | ğŸ“¦ å½’æ¡£ |
| å¥–å­¦é‡‘ | scholarship, scholarship_application | archive/ | ğŸ“¦ å½’æ¡£ |
| å­¦è´¹ç®¡ç† | tuition_bill, tuition_payment, tuition_standard | archive/ | ğŸ“¦ å½’æ¡£ |

## æ‰§è¡Œè¿ç§»

### 1. é¦–æ¬¡éƒ¨ç½²ï¼ˆå…¨æ–°æ•°æ®åº“ï¼‰

```bash
# ä½¿ç”¨ Maven
mvn flyway:migrate

# æˆ–ä½¿ç”¨ Spring Boot
mvn spring-boot:run
```

Flyway ä¼šè‡ªåŠ¨æŒ‰ç‰ˆæœ¬å·é¡ºåºæ‰§è¡Œæ‰€æœ‰è¿ç§»è„šæœ¬ã€‚

### 2. å¢é‡æ›´æ–°ï¼ˆå·²æœ‰æ•°æ®åº“ï¼‰

å½“æœ‰æ–°çš„è¿ç§»è„šæœ¬æ—¶ï¼š

```bash
# æŸ¥çœ‹å¾…æ‰§è¡Œçš„è¿ç§»
mvn flyway:info

# æ‰§è¡Œè¿ç§»
mvn flyway:migrate

# éªŒè¯è¿ç§»çŠ¶æ€
mvn flyway:validate
```

### 3. æŸ¥çœ‹è¿ç§»å†å²

```sql
SELECT 
    installed_rank,
    version,
    description,
    type,
    script,
    installed_on,
    execution_time,
    success
FROM flyway_schema_history
ORDER BY installed_rank;
```

### 4. å›æ»šè¿ç§»

âš ï¸ **Flyway ç¤¾åŒºç‰ˆä¸æ”¯æŒè‡ªåŠ¨å›æ»š**

å¦‚éœ€å›æ»šï¼Œè¯·ï¼š
1. æ‰‹åŠ¨ç¼–å†™å›æ»š SQL
2. ä½¿ç”¨æ•°æ®åº“å¤‡ä»½æ¢å¤
3. è€ƒè™‘å‡çº§åˆ° Flyway Teams ç‰ˆæœ¬

## æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **ç‰ˆæœ¬å·è¿ç»­**ï¼šä½¿ç”¨è¿ç»­çš„ç‰ˆæœ¬å·ï¼Œé¿å…è·³è·ƒ
2. **æè¿°æ¸…æ™°**ï¼šæ–‡ä»¶åå’Œè„šæœ¬æ³¨é‡Šæ¸…æ¥šè¯´æ˜å˜æ›´å†…å®¹
3. **å‘åå…¼å®¹**ï¼šé¿å…ç ´åæ€§å˜æ›´ï¼ˆå¦‚åˆ é™¤åˆ—ï¼‰
4. **å¹‚ç­‰æ€§**ï¼šä½¿ç”¨ `IF NOT EXISTS` ç­‰æ¡ä»¶è¯­å¥
5. **åˆ†æ­¥è¿ç§»**ï¼šå¤æ‚å˜æ›´æ‹†åˆ†ä¸ºå¤šä¸ªå°ç‰ˆæœ¬
6. **å…ˆæµ‹è¯•**ï¼šåœ¨å¼€å‘/æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯åå†å‘å¸ƒ

### âŒ é¿å…çš„åšæ³•

1. **ä¿®æ”¹å·²æ‰§è¡Œçš„è„šæœ¬**ï¼šä¼šå¯¼è‡´æ ¡éªŒå’Œä¸åŒ¹é…
2. **ç›´æ¥åˆ é™¤è¡¨/åˆ—**ï¼šè€ƒè™‘è½¯åˆ é™¤æˆ–åˆ†æ­¥åºŸå¼ƒ
3. **è·³è¿‡ç‰ˆæœ¬å·**ï¼šä¿æŒç‰ˆæœ¬è¿ç»­æ€§
4. **ç”Ÿäº§ç¯å¢ƒç›´æ¥æµ‹è¯•**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
5. **æ··åˆ DDL å’Œå¤§é‡ DML**ï¼šæ•°æ®è¿ç§»å•ç‹¬å¤„ç†

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæ ¡éªŒå’Œä¸åŒ¹é…

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Migration checksum mismatch for migration version X
```

**åŸå› **ï¼šå·²æ‰§è¡Œçš„è¿ç§»è„šæœ¬è¢«ä¿®æ”¹

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# é€‰é¡¹1ï¼šä¿®å¤æ ¡éªŒå’Œï¼ˆä¸æ¨èï¼‰
mvn flyway:repair

# é€‰é¡¹2ï¼šå›æ»šä¿®æ”¹ï¼Œåˆ›å»ºæ–°ç‰ˆæœ¬
```

---

### é—®é¢˜2ï¼šè¿ç§»å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Migration V20__xxx failed
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—ç¡®å®šåŸå› 
2. æ‰‹åŠ¨ä¿®å¤æ•°æ®åº“é—®é¢˜
3. ä½¿ç”¨ `flyway:repair` æ¸…é™¤å¤±è´¥è®°å½•
4. é‡æ–°æ‰§è¡Œ `flyway:migrate`

---

### é—®é¢˜3ï¼šå¤–é”®çº¦æŸé”™è¯¯

**åŸå› **ï¼šè¡¨ä¹‹é—´ä¾èµ–å…³ç³»ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥è¿ç§»è„šæœ¬ä¸­çš„å¤–é”®å®šä¹‰
2. ç¡®ä¿è¢«å¼•ç”¨çš„è¡¨å·²å­˜åœ¨
3. ä¸´æ—¶ç¦ç”¨å¤–é”®æ£€æŸ¥ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰ï¼š
   ```sql
   SET FOREIGN_KEY_CHECKS = 0;
   -- æ‰§è¡Œè¿ç§»
   SET FOREIGN_KEY_CHECKS = 1;
   ```

## ç¯å¢ƒé…ç½®

### å¼€å‘ç¯å¢ƒ (application-dev.yml)

```yaml
spring:
  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration
    encoding: UTF-8
    validate-on-migrate: true
```

### ç”Ÿäº§ç¯å¢ƒ (application-prod.yml)

```yaml
spring:
  flyway:
    enabled: true
    baseline-on-migrate: false  # ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ä¸º false
    locations: classpath:db/migration
    encoding: UTF-8
    validate-on-migrate: true
    out-of-order: false         # ä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œ
```

## ç›¸å…³èµ„æº

- **Flyway å®˜æ–¹æ–‡æ¡£**: https://flywaydb.org/documentation/
- **MySQL 8.0 æ–‡æ¡£**: https://dev.mysql.com/doc/refman/8.0/en/
- **é¡¹ç›®éƒ¨ç½²æŒ‡å—**: [../../../DEPLOY.md](../../../DEPLOY.md)
- **è¿ç§»æ–‡ä»¶è¯¦æƒ…**: [migration/README.md](migration/README.md)
- **æµ‹è¯•æ•°æ®æŒ‡å—**: [test-data/README.md](test-data/README.md)

## ç»´æŠ¤å›¢é˜Ÿ

å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦æ”¯æŒï¼Œè¯·è”ç³»ï¼š
- **æ•°æ®åº“ç®¡ç†**: traceck1@gmail.com
- **æŠ€æœ¯æ”¯æŒ**: [GitHub Issues](https://github.com/tangqingfeng7/university-academic-system/issues)

---

**æœ€åæ›´æ–°**: 2025-10-13  
**ç»´æŠ¤è€…**: traceck1@gmail.com  
**ç‰ˆæœ¬**: 1.0

